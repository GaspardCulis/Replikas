---
import TextField from '../components/TextField.astro';
import Layout from '../layouts/Layout.astro';
import Button from '../components/Button.astro';
import axios from 'axios';
import sgMail from '@sendgrid/mail';
//import tokenGenerator from '@tokenGenerator';
import { getAccountBySession } from '../model/Utilitaire';
import Account from '../model/users/Account';

if (Astro.request.method == 'POST') {
	const formData = await Astro.request.formData();
	if (!formData.has('email')) {
		return Astro.redirect('/recover-password?error=missing_field');
	}
	const email = formData.get('email').toString();
	// check if user exists in database
	const user: Account = await getAccountBySession(Astro.request.headers).catch(
		() => null
	);
	user.getEmail();
	if (!user) {
		return Astro.redirect('/recover-password?error=user_not_found');
	}
	sgMail.setApiKey(process.env.SENDGRID_API_KEY);
	// generate a password reset token and save it to the user in the database
	//const token = tokenGenerator();
	//user.getEmail = token;
	//await user.({ passwordResetToken: token }, { where: { email: email } });

	// send email to user with password reset link
	const msg = {
		to: email,
		from: 'noreply@example.com',
		subject: 'Réinitialisation de mot de passe',
		html: `Cliquezsur ce lien pour réinitialiser votre mot de passe: http://example.com/reset-password?token=`,
	};
	try {
		await sgMail.send(msg);
		return Astro.redirect('recover-password?success=true');
	} catch (error) {
		console.error(error);
		return new Response('Internal server error', {
			status: 500,
		});
	}
}

////
////
////

let error_msg = '';
let success_msg = '';
if (Astro.url.searchParams.has('error')) {
	const error = Astro.url.searchParams.get('error');
	if (error == 'missing_field') {
		error_msg = 'Please enter your email';
	} else if (error == 'user_not_found') {
		error_msg = 'No account found with that email';
	}
} else if (Astro.url.searchParams.has('success')) {
	success_msg =
		'An email has been sent with instructions on how to reset your password';
}
---

<Layout title="Recuperer le mot de passe">
	<main>
		<h1>Recover your password</h1>
		{error_msg && <p class="error_msg">{error_msg}</p>}
		{success_msg && <p class="success_msg">{success_msg}</p>}
		<form method="post" action="/recover-password">
			<table>
				<tr>
					<th>Email:</th>
					<td>
						<div class="textfield">
							<TextField
								placeholder="Entrer votre email"
								name="email"
								type="email"
								length="20rem"
							/>
						</div>
					</td>
				</tr>
			</table>
		</form>
		<div id="btn">
			<Button text="Recuperer le mot de passe" />
		</div>
	</main>
</Layout>

<style>
	table {
		width: 70%;
		margin: auto;
	}

	th {
		text-align: end;
	}

	td {
	}
	.textfield {
		text-align: center;
	}
	#btn {
		text-align: center;
	}
	main {
		margin: auto;
		padding-top: 1.5rem;
		padding-bottom: 1.5rem;
		padding-left: 3rem;
		padding-right: 3rem;
		max-width: 80ch;
		background-color: var(--theme-secondary);
		border-radius: 15px;
	}

	h1 {
		text-align: center;
		font-size: 25px;
	}
</style>
