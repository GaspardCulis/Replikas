---
import TextField from '../components/TextField.astro';
import Layout from '../layouts/Layout.astro';
import Button from '../components/Button.astro';

if (Astro.request.method == 'POST') {
	const formData = await Astro.request.formData();
	if (!formData.has('email')) {
		return Astro.redirect('/recover-password?error=missing_field');
	}
	const email = formData.get('email').toString();
	try {
		// send an email to the user with a link to reset their password using the token
		return Astro.redirect('/recover-password?success=true');
	} catch (e) {
		//erreurs else {
		console.error(e);
		return new Response('Internal server error', {
			status: 500,
		});
	}
}

let error_msg = '';
let success_msg = '';
if (Astro.url.searchParams.has('error')) {
	const error = Astro.url.searchParams.get('error');
	if (error == 'missing_field') {
		error_msg = 'Please enter your email';
	} else if (error == 'user_not_found') {
		error_msg = 'No account found with that email';
	}
} else if (Astro.url.searchParams.has('success')) {
	success_msg =
		'An email has been sent with instructions on how to reset your password';
}
---

<Layout title="Recuperer le mot de passe">
	<main>
		<h1>Recover your password</h1>
		{error_msg && <p class="error_msg">{error_msg}</p>}
		{success_msg && <p class="success_msg">{success_msg}</p>}
		<form method="post" action="/recover-password">
			<table>
				<tr>
					<th>Email:</th>
					<td>
						<div class="textfield">
							<TextField
								placeholder="Entrer votre email"
								name="email"
								type="email"
								length="20rem"
							/>
						</div>
					</td>
				</tr>
			</table>
		</form>
		<div id="btn">
			<Button text="Recuperer le mot de passe" />
		</div>
	</main>
</Layout>

<style>
	.textfield {
		text-align: center;
	}
	#btn {
		text-align: center;
	}
	main {
		margin: auto;
		padding-top: 1.5rem;
		padding-bottom: 1.5rem;
		padding-left: 3rem;
		padding-right: 3rem;
		max-width: 80ch;
		background-color: var(--theme-secondary);
		border-radius: 15px;
	}

	h1 {
		text-align: center;
		font-size: 25px;
	}
</style>
