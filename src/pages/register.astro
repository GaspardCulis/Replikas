---
import Layout from "../layouts/Layout.astro";
import TextField from "../components/TextField.astro";
import Button from "../components/Button.astro";
import Buyer from "../model/users/Buyer";
import { EmailDejaUtiliseError } from "../model/users/Account";

if (Astro.request.method == "POST") {
  const formData = await Astro.request.formData();
  const { last_name, first_name, email, password, password_confirm } =
    Object.fromEntries(formData) as {
      last_name: string;
      first_name: string;
      email: string;
      password: string;
      password_confirm: string;
    };

  if (
    ![last_name, first_name, email, password, password_confirm].every(
      (value) => value
    )
  )
    return Astro.redirect("/register?error=missing_field");
  if (password != password_confirm)
    return Astro.redirect("/register?error=password_mismatch");
  // Vérification du mail
  if (
    !/^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-]+)(\.[a-zA-Z]{2,5}){1,2}$/.test(email)
  )
    return Astro.redirect("/register?error=invalid_email");
  // Mot de passe fort https://www.section.io/engineering-education/password-strength-checker-javascript/
  if (
    !/(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})/.test(
      password
    )
  )
    return Astro.redirect("/register?error=weak_password");

  try {
    await Buyer.createBuyer(email, password, last_name, first_name);
  } catch (e) {
    if (e instanceof EmailDejaUtiliseError) {
      return Astro.redirect("/register?error=already_exists");
    } else {
      // Si une autre erreur non prevue est survenue
      console.error(e);
      return Astro.response.status(500).send("Internal server error");
    }
  }
  return Astro.redirect("/login?info=account_created");
}

// Si on a reçu un paramètre "error"
let error_msg = "";
if (Astro.url.searchParams.has("error")) {
  // On affiche un message d'erreur
  const error = Astro.url.searchParams.get("error");
  if (error == "missing_field") {
    error_msg = "Veuillez remplir tous les champs";
  } else if (error == "password_mismatch") {
    error_msg = "Les mots de passe ne correspondent pas";
  } else if (error == "invalid_email") {
    error_msg = "L'adresse email n'est pas valide";
  } else if (error == "weak_password") {
    error_msg =
      "Le mot de passe doit contenir au moins 8 caractères, une majuscule, une minuscule, un chiffre et un caractère spécial";
  } else if (error == "already_exists") {
    error_msg = "Un compte avec cette adresse email existe déjà";
  }
}
---

<Layout title="Register" no_searchbar>
  <main>
    <form method="post" class="formlist">
      <h1>Créer votre compte</h1>
      <table>
        <tr>
          <th>Nom :</th>
          <td>
            <TextField
              text=""
              placeholder="Entrez votre nom"
              length="15rem"
              name="last_name"
            />
          </td>
        </tr>
        <tr>
          <th>Prénom :</th>
          <td>
            <TextField
              text=""
              placeholder="Entrez votre prénom"
              length="15rem"
              name="first_name"
            />
          </td>
        </tr>
        <tr>
          <th>E-mail :</th>
          <td>
            <TextField
              text=""
              placeholder="Entrez votre e-mail"
              type="email"
              length="15rem"
              name="email"
            />
          </td>
        </tr>
        <tr>
          <th>Mot de passe :</th>
          <td>
            <TextField
              text=""
              placeholder="Entrez votre mot de passe"
              type="password"
              length="15rem"
              name="password"
            />
          </td>
        </tr>
        <tr>
          <th>Nom :</th>
          <td>
            <TextField
              text=""
              placeholder="Confirmer le mot de passe"
              type="password"
              length="15rem"
              name="password_confirm"
            />
          </td>
        </tr>
      </table>

      <div id="button">
        <div>
          <input type="checkbox" required />
          <span> J'accepte les conditions générales d'utilisation</span>
        </div>
        <Button text="S'inscrire" />
        {error_msg && <p class="error_msg">{error_msg}</p>}
      </div>
    </form>
  </main>
</Layout>

<style>
  .formlist {
    padding: 1.5rem 3rem;
    margin: 1rem auto;
    max-width: 80ch;

    border-radius: 1rem;

    background-color: #222222;
  }

  /*-----------------Table--------------------*/

  table {
    width: 80%;
    margin: 1rem auto;
  }

  th {
    text-align: end;

    color: whitesmoke;
  }

  td {
    text-align: center;
  }

  /*-----------------Boutton s'inscrire--------------------*/

  #button {
    color: whitesmoke;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #button div {
    text-align: center;
    margin-bottom: 1rem;
  }

  /*-----------------Texts--------------------*/
  h1 {
    font-size: 2rem;
    text-align: center;
    margin: 2rem 0;
    color: whitesmoke;
  }
  .error_msg {
    color: red;
  }
</style>
