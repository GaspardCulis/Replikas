---
import Layout from '../layouts/Layout.astro';
import SearchBar from '../components/SearchBar.astro';
import Article from '../components/Article.astro';
import { default as ArticleModel } from '../model/Article';
import Filter from '../components/Filter.astro';

const PAGE_SIZE = 20;
const search = Astro.url.searchParams.get('article') || '';
const page = Math.max(parseInt(Astro.url.searchParams.get('page')) || 1, 1);

let articles = await ArticleModel.getBySearch(search, {
	limit: null,
	offset: 0,
});

const length = articles.length;
const hasMore = articles.length > page * PAGE_SIZE;
articles = articles.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
const pages = [...Array(Math.ceil(length / PAGE_SIZE)).values()];
---

<Layout title="Replikas" no_searchbar>
	<main>
		<div class="searchBar">
			<div id="searchBar">
				<SearchBar text={search} />
			</div>
			<div id="filter-icon">
				<img src="/img/icons/filter.png" alt="" />
			</div>
		</div>
		<div id="filter">
			<Filter />
		</div>
		<ul>
			{
				articles.length > 0 ? (
					articles.map((article) => <Article article={article} />)
				) : (
					<p>Il n'y a aucun article correspondant à la recherche</p>
				)
			}
		</ul>
		<div class="pages">
			<span>
				{
					page > 1 && (
						<a href={`?article=${search}&page=${page - 1}`}>Précédent</a>
					)
				}
				{
					pages.map((_, i) => (
						<a
							href={`?article=${search}&page=${i + 1}`}
							class={i + 1 === page ? 'active' : ''}
						>
							{i + 1}
						</a>
					))
				}

				{hasMore && <a href={`?article=${search}&page=${page + 1}`}>Suivant</a>}
			</span>
		</div>
	</main>
</Layout>

<style>
	main {
		margin: 20px auto;
		padding: 20px 2%;
		width: 80%;

		border-radius: 20px;

		background-color: var(--theme-secondary);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

	/*---------Search & Filter-----------*/
	.searchBar {
		margin: 10px 20% 20px 20%;
		width: 80%;

		display: flex;
		flex-wrap: wrap;
		align-items: center;
		justify-content: center;
	}

	#searchBar {
		width: 70%;
	}

	#filter-icon {
		filter: invert(0.9);
		scale: 0.9;
		cursor: pointer;
	}

	#filter {
		background-color: var(--theme-primary);

		width: 80%;
		height: 0;
		padding: 1rem 2rem;

		border-radius: 1rem;
		overflow: hidden;

		opacity: 0;
		visibility: hidden;
		z-index: 1;
		-webkit-transition: all 1s ease;
		-moz-transition: all 1s ease;
		-ms-transition: all 1s ease;
		-o-transition: all 1s ease;
		transition: all 1s ease;
	}

	.show {
		opacity: 1 !important;
		visibility: visible !important;
		height: auto !important;
	}

	/*-----------Articles-------------*/
	ul {
		margin-inline: auto;
		width: 100%;
		display: flex;
		flex-wrap: wrap;
		align-self: center;
	}

	/*------------Change page---------------*/
	.pages {
		text-align: center;
		margin: 20px 0;
	}

	.pages > span {
		display: inline-block;

		border-radius: 10px;

		background-color: var(--theme-button);
	}

	.pages > span > a {
		background-color: var(--theme-button);
		text-decoration: none;
		color: inherit;

		display: inline-block;

		height: 46px;
		line-height: 46px;
		padding: 0 14px;
	}

	.pages > span > a.active {
		filter: brightness(0.8);
	}

	.pages > span > a:hover {
		filter: brightness(1.2);
	}

	.pages > span > a:active {
		filter: brightness(0.8);
	}

	.pages > span > a:last-child {
		border-top-right-radius: 10px;
		border-bottom-right-radius: 10px;
	}

	.pages > span > a:first-child {
		border-top-left-radius: 10px;
		border-bottom-left-radius: 10px;
	}
</style>
<script>
	const filterIcon = document.getElementById('filter-icon');
	const filter = document.getElementById('filter');

	filterIcon.addEventListener('click', (e) => {
		if (filter.classList.contains('show')) {
			filter.classList.remove('show');
		} else {
			filter.classList.toggle('show');
		}
	});
</script>
