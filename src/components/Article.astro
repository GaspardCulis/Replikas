---
import Article from '../model/Article';
import Buyer from '../model/users/Buyer';
import { getBuyerBySession } from '../model/Utilitaire';

export interface Props {
	article: Article;
}

const article = Astro.props.article || Article.getFallback(null);

const id = article.getId();
const titre = article.getName();
const image = await article.getPoster();
const prix = article.getPrixBase();
const dateDebut = article.getDebutVente();
const dateFin = article.getFinVente();

let buyer: Buyer = await getBuyerBySession(Astro.request.headers).catch(
	() => null
);
const liked = buyer && (await article.isLikedBy(buyer));

const date = dateDebut > new Date() ? dateDebut : dateFin;
const enCours = dateDebut < new Date() && dateFin > new Date();
---

<li>
	<script is:inline src="/src/like.js"></script>
	<!-- BCP d'instanciations pas grave le browser gere -->
	<div class="like-container">
		<img
			src="/img/icons/heart.svg"
			onclick="likeArticle(this, event)"
			onload="updateColor(this)"
			data-id={id}
			data-liked={'' + liked}
			class="filter-whitesmoke"
		/>
	</div>
	<img src={image} alt={titre} class="poster" />
	<a href={'/auction/' + id}>
		<h3>{titre}</h3>
		<p>
			{
				enCours
					? 'Finit le ' + date.toLocaleDateString()
					: 'Débute le ' + date.toLocaleDateString()
			}
		</p>
		<p>{prix} €</p>
	</a>
	<style>
		li {
			width: 300px;
			margin: 20px;

			display: flex;
			flex-direction: column;

			background-color: var(--theme-primary);

			border-radius: 10px;
			overflow: hidden;
		}

		li:hover {
			box-shadow: 0 0 10px var(--theme-primary);
		}

		li a {
			text-decoration: none;
			color: inherit;
		}

		.like-container {
			position: absolute;
			width: 300px;
			height: fit-content;
			display: flex;
			justify-content: flex-end;
		}

		.like-container img {
			width: 30px;
			height: 30px;
			z-index: 1;
			margin: 5px;
			cursor: pointer;
		}

		.poster {
			width: 100%;
			height: 250px;
			object-fit: cover;
		}

		h3,
		p {
			margin: 0;
			padding: 5px;
		}
	</style>
</li>
